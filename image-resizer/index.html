<script>
(function() {
  'use strict';
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
  
  function init() {
    const resizeBtn = document.getElementById('resizeBtn');
    const sizeSelect = document.getElementById('sizeSelect');
    const customSize = document.getElementById('customSize');
    const widthInput = document.getElementById('width');
    const heightInput = document.getElementById('height');
    const imageFile = document.getElementById('imageFile');
    const loading = document.getElementById('loading');
    const result = document.getElementById('result');
    const imgPreview = document.getElementById('imgPreview');
    
    resizeBtn.addEventListener('click', resizeImage);
    sizeSelect.addEventListener('change', handleSizeChange);
    imageFile.addEventListener('change', updatePreview);
    if (widthInput) widthInput.addEventListener('input', checkCustom);
    if (heightInput) heightInput.addEventListener('input', checkCustom);
    
    const shareBtn = document.querySelector('.share-btn');
    if (shareBtn) {
      shareBtn.addEventListener('click', handleShare);
      shareBtn.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          handleShare();
        }
      });
    }
  }
  
  function handleSizeChange() {
    const customSize = document.getElementById('customSize');
    customSize.style.display = (this.value === 'custom') ? 'block' : 'none';
  }
  
  function updatePreview() {
    const file = document.getElementById('imageFile').files[0];
    const imgPreview = document.getElementById('imgPreview');
    imgPreview.innerHTML = '';
    
    if (file && file.type.startsWith('image/')) {
      const url = URL.createObjectURL(file);
      imgPreview.innerHTML = `
        <img src="${url}" alt="Original Preview" style="max-width:90%; max-height:240px; border-radius:12px; display:block; margin:8px auto; border:2px solid var(--border);">
      `;
    }
  }
  
  function checkCustom() {
    // Optional real-time feedback if needed
  }
  
  function getDelay() {
    // Random realistic delay based on "network" feel (1.2s to 3s)
    return Math.floor(Math.random() * (3000 - 1200 + 1)) + 1200;
  }
  
  function resizeImage() {
    const file = document.getElementById('imageFile').files[0];
    const sizeSelectVal = document.getElementById('sizeSelect').value;
    const result = document.getElementById('result');
    const loading = document.getElementById('loading');
    const imgPreview = document.getElementById('imgPreview');
    
    result.style.display = 'none';
    loading.style.display = 'none';
    
    if (!file) {
      result.textContent = 'Please upload an image first.';
      result.style.display = 'block';
      return;
    }
    
    if (!file.type.startsWith('image/')) {
      result.textContent = 'Please upload a regular image file.';
      result.style.display = 'block';
      return;
    }
    
    if (sizeSelectVal === '') {
      result.textContent = 'Please select an image size.';
      result.style.display = 'block';
      return;
    }
    
    let targetWidth, targetHeight;
    if (sizeSelectVal === 'custom') {
      targetWidth = parseInt(document.getElementById('width').value);
      targetHeight = parseInt(document.getElementById('height').value);
      if (isNaN(targetWidth) || isNaN(targetHeight) || targetWidth < 1 || targetHeight < 1) {
        result.textContent = 'Please enter valid width and height (positive numbers).';
        result.style.display = 'block';
        return;
      }
    } else {
      [targetWidth, targetHeight] = sizeSelectVal.split('x').map(Number);
    }
    
    loading.style.display = 'block';
    
    const img = new Image();
    img.onload = () => {
      setTimeout(() => {
        const canvas = document.createElement('canvas');
        canvas.width = targetWidth;
        canvas.height = targetHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, targetWidth, targetHeight);
        
        const resizedDataUrl = canvas.toDataURL('image/jpeg', 0.92);
        
        loading.style.display = 'none';
        
        // 1. Remove original preview and show ONLY resized preview
        imgPreview.innerHTML = `
          <img src="${resizedDataUrl}" alt="Resized Preview" style="max-width:90%; max-height:240px; border-radius:12px; display:block; margin:8px auto; border:2px solid var(--border);">
        `;
        
        // 2. Below the preview: result text + download button
        result.innerHTML = `
          <strong>Resized to:</strong> ${targetWidth}px √ó ${targetHeight}px
          <br>
          <a href="${resizedDataUrl}" download="resized_${targetWidth}x${targetHeight}.jpg" class="calculate-btn" style="margin-top:16px; display:inline-block; text-decoration:none;">Download Resized Image</a>
        `;
        result.style.display = 'block';
        
      }, getDelay());  // realistic random delay
    };
    
    img.onerror = () => {
      loading.style.display = 'none';
      result.textContent = 'Cannot process this image. Try another file.';
      result.style.display = 'block';
    };
    
    img.src = URL.createObjectURL(file);
  }
  
  async function handleShare() {
    const shareData = {
      title: 'Image Resizer ‚Äì Skill2Job Tools',
      text: 'Resize images online instantly! üìè',
      url: window.location.href
    };
    try {
      if (navigator.share) {
        await navigator.share(shareData);
      } else if (navigator.clipboard) {
        await navigator.clipboard.writeText(shareData.url);
        alert('Link copied!');
      }
    } catch (err) {
      prompt('Copy this link:', shareData.url);
    }
  }
})();
</script>
